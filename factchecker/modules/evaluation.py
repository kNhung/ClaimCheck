from .llm import prompt_ollama

judge_prompt = """HƯỚNG DẪN
Bạn là người kiểm chứng sự thật. Dựa vào BẢN GHI, hãy SUY LUẬN và đưa ra PHÁN QUYẾT cuối cùng cho YÊU CẦU (Claim).

PHÁN QUYẾT HỢP LỆ:
{options}

QUY TẮC:
{rules}

YÊU CẦU ĐẦU RA:
- Gồm **hai phần duy nhất**, đúng thứ tự và đúng tiêu đề:
### Justification:
<1 đoạn SUY LUẬN ngắn, giải thích vì sao chọn phán quyết. Không lặp lại Claim. Không tóm tắt toàn bộ Record.>
### Verdict:
<1 từ trong {options}, đặt trong dấu backtick. Không thêm chữ khác.>

QUAN TRỌNG: mục ### Verdict chỉ in DUY NHẤT MỘT TỪ, đặt trong dấu `...`.

VÍ DỤ:
### Justification:
Bằng chứng trong Record đều xác nhận rằng Hà Nội là thủ đô của Việt Nam.
### Verdict:
`Supported`

BẢN GHI:
{record}

In ra kết quả theo đúng ĐỊNH DẠNG và VÍ DỤ ở trên:
"""


verdict_extraction_prompt = """HƯỚNG DẪN
Bạn là người kiểm chứng sự thật.
Hãy trích xuất duy nhất phán quyết cuối cùng từ KẾT LUẬN sau.
Phán quyết phải thuộc một trong các tùy chọn dưới đây.

TÙY CHỌN PHÁN QUYẾT:
{options}

QUY TẮC:
{rules}

ĐỊNH DẠNG ĐẦU RA:
In DUY NHẤT MỘT TỪ PHÁN QUYẾT (KHÔNG thêm lời giải thích), đặt trong dấu backtick `...`.

KẾT LUẬN:
{conclusion}

In ra KẾT QUẢ theo ĐỊNH DẠNG ĐẦU RA ở trên:
"""

def judge(record, decision_options, rules="", think=True):
    """
    Determines the veracity of a claim based on the provided record and decision options.

    Args:
        record (str): The record containing evidence for the judgement.
        decision_options (str): The available decision options to choose from.
        extra_rules (str): Additional rules to consider in the judgement.
        think (bool): Whether to use chain-of-thought (default True)
    Returns:
        str: The judgement generated by the LLM.
    """
    prompt = judge_prompt.format(record=record, options=decision_options, rules=rules)
    return prompt_ollama(prompt, think=think)

def extract_verdict(conclusion, decision_options, rules=""):
    """
    Extracts the verdict from the conclusion of a fact-check.

    Args:
        conclusion (str): The conclusion text from which to extract the verdict.
        decision_options (str): The available decision options to choose from.
        rules (str): Additional rules to consider in the extraction.
    
    Returns:
        str: The extracted verdict.
    """
    prompt = verdict_extraction_prompt.format(conclusion=conclusion, options=decision_options, rules=rules)
    return prompt_ollama(prompt, think=False)